# on:
#   push:
#     branches:
#       - main

# jobs:
#   Build-Python-Artifacts:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v6.0.2
#       - name: Setup Python
#         uses: actions/setup-python@v6.2.0
#         with:
#           python-vesrion: '3.10'
#           cache: 'pip'
#       - name: Install dependncy
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
  
#       - name: Run test
#         run: |
#            pip install pytest pytest-cov
#            pytest
#       - name: Build the artifact
#         run: |
#           mkdir build 
#           cp app.py requirements.txt README.md nginx.conf calculator.service build/
#           zip -r python-app.zip build/
#       - name: Upload a Build Artifact
#         uses: actions/upload-artifact@v6.0.0
#         with:
#           name: python-app
#           path: python-app.zip
#           retention-days: 1
#   deploy-on-aws:
#      needs: Build-Python-Artifacts
#      runs-on: ubuntu-latest
#      steps:
#       - name: Download a Build Artifact
#         uses: actions/download-artifact@v7.0.0
#         with:
#           name: python-app
#           path: .
#       - name: list the direstory
#         run: |
#           ls -al
#       - name: copy content 
#         run: echo "${{ secrets.SSH_KEY }}" > devops-tos.pem
#       - name: give permission
#         run: chmod 600 devops-tos.pem
#       - name: login to ssh
#         run: |
#           ssh -o StrictHostKeyChecking=no -i devops-tos.pem ${{ vars.SSH_USER }}@${{ vars.SERVER_IP }} << 'ENDSSH'
#           if [ ! -d /home/ubuntu/suman2 ]; then
#            mkdir /home/ubuntu/suman2
#           fi
#           ENDSSH
#       - name: SCP artifacts to server
#         run: scp -i devops-tos.pem -rv python-app.zip ${{vars.SSH_USER}}@${{vars.SERVER_IP}}:/home/ubuntu/suman2
#       - name: Run the program
#         run: |
#           ssh -o StrictHostKeyChecking=no -i devops-tos.pem ${{ vars.SSH_USER }}@${{ vars.SERVER_IP }} << 'ENDSSH'
#           cd /home/ubuntu/suman2
#           unzip -o python-app.zip
#           pip3 install -r build/requirements.txt
#           sudo fuser -k 8000/tcp || true
#           nohup python3 build/app.py > app.log 2>&1 & 
#           ENDSSH

on: 
  push:
    branches:
      - main
jobs:
    build-docker-image:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v6.0.2
        - name: list content od folder
          run: ls -al
        - name: Run docker build command
          run: docker build -t sumail829/pyapp:latest .
        - name: Docker Login
          uses: docker/login-action@v3.7.0
          with:
            username: ${{ vars.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
        - name: push to docker hub
          run: docker push sumail829/pyapp:latest
          
    deploy-to-aws:
        runs-on: ubuntu-latest
        steps:
          - name: copy content
            run: echo "${{ secrets.DOCKERHUB_TOKEN }}" > devops-tos.pem
          - name: give permission
            run: chmod 600 devops-tos.pem
          - name: login to server
            run: |
              ssh -o StrictHostKeyChecking=no -i devops-tos.pem ${{ vars.SSH_USER }}@${{ vars.SERVER_IP }} << 'ENDSSH'
                docker pull sumail829/pyapp:latest
                docker run -d -p 3006:8000 sumail829/pyapp:latest
              ENDSSH












